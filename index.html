<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bond Energy Simulator</title>

  <!-- Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- React + Babel + Recharts -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js" defer></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div id="root" class="p-6 text-center">Loading Bond Energy Simulator…</div>

  <script type="text/babel">
  console.log("✅ Bond Energy Simulator running...");

  const { useState, useMemo } = React;
  const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, Cell } = Recharts;

  const COLORS = {
    H: "#ffffff",
    O: "#ef4444",
    C: "#111111",
    N: "#2563eb",
    Cl: "#22c55e"
  };

  const THEME = {
    REACTANT: "#10b981", // green
    PRODUCT: "#3b82f6"   // blue
  };

  const DEFAULT_BOND_ENERGIES = {
    "H–H": 436, "Cl–Cl": 243, "H–Cl": 431, "O=O": 498, "O–H": 463,
    "C–H": 413, "C–C": 348, "C=C": 614, "C=O": 799, "C–O": 358, "O–O": 146,
    "N≡N": 945, "N–H": 391
  };

  const PRESETS = [
    { id: "hcl", name: "H₂ + Cl₂ → 2 HCl", description: "Synthesis of hydrogen chloride" },
    { id: "combustion", name: "CH₄ + 2 O₂ → CO₂ + 2 H₂O", description: "Combustion of methane" },
    { id: "haber", name: "N₂ + 3 H₂ → 2 NH₃", description: "Haber process" },
    { id: "water_split", name: "2 H₂O → 2 H₂ + O₂", description: "Electrolysis of water" },
    { id: "ethanol_combustion", name: "C₂H₅OH + 3 O₂ → 2 CO₂ + 3 H₂O", description: "Combustion of ethanol" },
  ];

  // ---------- Helpers ----------
  const clampInt = (n) => Math.max(0, Math.round(Number(n) || 0));
  const uid = () => Math.random().toString(36).slice(2, 8);
  const sumEnergy = (counts, energies) =>
    Object.entries(counts).reduce((s,[k,c]) => s + (energies[k] || 0)*(Number(c)||0), 0);

  // ---------- Molecule builder ----------
  function A(id, element, x, y){ return { id, element, x, y }; }
  function B(a, b, key, order=1){ return { id: uid(), a, b, key, order }; }

  function buildModels(presetId){
    if(!presetId) return { reactants:[], products:[] };

    const H2 = { name:"H₂", atoms:[A("h1","H",30,40),A("h2","H",90,40)], bonds:[B("h1","h2","H–H",1)] };
    const Cl2 = { name:"Cl₂", atoms:[A("c1","Cl",30,40),A("c2","Cl",90,40)], bonds:[B("c1","c2","Cl–Cl",1)] };
    const HCl = { name:"HCl", atoms:[A("h","H",30,40),A("cl","Cl",90,40)], bonds:[B("h","cl","H–Cl",1)] };
    const O2 = { name:"O₂", atoms:[A("o1","O",30,40),A("o2","O",90,40)], bonds:[B("o1","o2","O=O",2)] };
    const CO2 = { name:"CO₂", atoms:[A("o1","O",20,40),A("c","C",60,40),A("o2","O",100,40)],
      bonds:[B("o1","c","C=O",2),B("c","o2","C=O",2)] };
    const H2O = { name:"H₂O", atoms:[A("o","O",60,30),A("h1","H",25,60),A("h2","H",95,60)],
      bonds:[B("o","h1","O–H",1),B("o","h2","O–H",1)] };
    const CH4 = { name:"CH₄", atoms:[A("c","C",60,40),A("h1","H",20,15),A("h2","H",20,65),
      A("h3","H",100,20),A("h4","H",100,60)],
      bonds:[B("c","h1","C–H"),B("c","h2","C–H"),B("c","h3","C–H"),B("c","h4","C–H")] };
    const N2 = { name:"N₂", atoms:[A("n1","N",30,40),A("n2","N",90,40)], bonds:[B("n1","n2","N≡N",3)] };
    const NH3 = { name:"NH₃", atoms:[A("n","N",60,40),A("h1","H",20,20),A("h2","H",20,60),A("h3","H",100,40)],
      bonds:[B("n","h1","N–H"),B("n","h2","N–H"),B("n","h3","N–H")] };

    switch(presetId){
      case "hcl": return { reactants:[H2,Cl2], products:[HCl,HCl] };
      case "combustion": return { reactants:[CH4,O2,O2], products:[CO2,H2O,H2O] };
      case "haber": return { reactants:[N2,H2,H2,H2], products:[NH3,NH3] };
      case "water_split": return { reactants:[H2O,H2O], products:[H2,O2] };
      case "ethanol_combustion":
        const C2H5OH = { name:"C₂H₅OH", atoms:[A("c1","C",30,40),A("c2","C",60,40),A("o","O",90,30),
          A("hO","H",110,30),A("h1","H",15,20),A("h2","H",15,60),A("h3","H",30,10),
          A("h4","H",60,10),A("h5","H",60,70)],
          bonds:[B("c1","c2","C–C"),B("c2","o","C–O"),B("o","hO","O–H"),
                 B("c1","h1","C–H"),B("c1","h2","C–H"),B("c1","h3","C–H"),
                 B("c2","h4","C–H"),B("c2","h5","C–H")] };
        return { reactants:[C2H5OH,O2,O2,O2], products:[CO2,CO2,H2O,H2O,H2O] };
      default: return { reactants:[], products:[] };
    }
  }

  function OrderStyle(order){
    if(order===2) return { width:4, offsets:[2.6,-2.6], glow:true };
    if(order===3) return { width:5, offsets:[0,4.2,-4.2], glow:true };
    return { width:3, offsets:[0], glow:false };
  }

  function offsetLine(x1,y1,x2,y2,k){
    const dx=x2-x1, dy=y2-y1;
    const len=Math.hypot(dx,dy)||1;
    const nx=-dy/len, ny=dx/len;
    return { x1:x1+nx*k, y1:y1+ny*k, x2:x2+nx*k, y2:y2+ny*k };
  }

  function Molecule({ model, onClickBond, themeColor }){
    return (
      <div className="bg-white rounded-xl p-2 shadow">
        <div className="text-xs font-medium mb-1 text-center" style={{ color: themeColor }}>{model.name}</div>
        <svg viewBox="0 0 120 80" className="w-full h-36">
          <defs>
            <filter id="bondGlow" x="-50%" y="-50%" width="200%" height="200%">
              <feDropShadow dx="0" dy="0" stdDeviation="1.2" floodColor={themeColor} floodOpacity="0.4" />
            </filter>
          </defs>

          {model.bonds.map((b) => {
            const a = model.atoms.find(x=>x.id===b.a);
            const c = model.atoms.find(x=>x.id===b.b);
            const style = OrderStyle(b.order||1);
            const lines = style.offsets.map(k => offsetLine(a.x,a.y,c.x,c.y,k));
            return (
              <g key={b.id} className="cursor-pointer"
                 onClick={(e)=>onClickBond(b.key,e.shiftKey)}
                 filter={style.glow?"url(#bondGlow)":undefined}>
                {lines.map((ln,j)=>(
                  <line key={j} x1={ln.x1} y1={ln.y1} x2={ln.x2} y2={ln.y2}
                        stroke={themeColor} strokeWidth={style.width} strokeLinecap="round" />
                ))}
                <line x1={a.x} y1={a.y} x2={c.x} y2={c.y} stroke="transparent" strokeWidth="14" />
              </g>
            );
          })}

          {model.atoms.map(atom => (
            <g key={atom.id}>
              <circle cx={atom.x} cy={atom.y} r="7" fill={COLORS[atom.element]||"#eee"}
                      stroke={themeColor} strokeWidth="2"></circle>
              <text x={atom.x} y={atom.y+3} fontSize="9" textAnchor="middle"
                    fill="#0f172a">{atom.element}</text>
            </g>
          ))}
        </svg>
        <div className="text-[11px] text-center text-slate-600">Tap bonds to tally (Shift = −1)</div>
      </div>
    );
  }
    // ---------- Panels + App ----------
  function ModelPanel({ side, title, presetId, onClickBond, themeColor }) {
    const models = React.useMemo(() => buildModels(presetId), [presetId]);
    const group = side === "r" ? models.reactants : models.products;
    return (
      <div className="rounded-2xl p-3" style={{ backgroundColor: themeColor + "20" }}>
        <div className="flex items-center justify-between mb-2">
          <h3 className="font-semibold" style={{ color: themeColor }}>{title}</h3>
          <div className="text-xs text-slate-500">Click = +1 · Shift + Click = −1</div>
        </div>
        {group.length === 0 ? (
          <div className="text-sm text-slate-500">Choose a preset to view molecules.</div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {group.map((m, i) => (
              <Molecule key={m.name + i} model={m} onClickBond={onClickBond} themeColor={themeColor} />
            ))}
          </div>
        )}
      </div>
    );
  }

  function App() {
    const [bondEnergies] = React.useState({ ...DEFAULT_BOND_ENERGIES });
    const [reactantCounts, setReactantCounts] = React.useState({});
    const [productCounts, setProductCounts] = React.useState({});
    const [currentPresetId, setCurrentPresetId] = React.useState(null);
    const [studentName, setStudentName] = React.useState("");
    const [studentPeriod, setStudentPeriod] = React.useState("");
    const [studentBroken, setStudentBroken] = React.useState("");
    const [studentFormed, setStudentFormed] = React.useState("");
    const [studentDelta, setStudentDelta] = React.useState("");
    const [studentType, setStudentType] = React.useState("");
    const [feedback, setFeedback] = React.useState("");

    const allKeys = Object.keys(bondEnergies);
    const sumBroken = sumEnergy(reactantCounts, bondEnergies);
    const sumFormed = sumEnergy(productCounts, bondEnergies);
    const trueDelta = sumBroken - sumFormed;

    const chartData = [
      { label: "ΣE Broken (Reactants)", energy: Number(studentBroken) || 0, fill: THEME.REACTANT },
      { label: "ΣE Formed (Products)",  energy: Number(studentFormed) || 0, fill: THEME.PRODUCT },
    ];

    function bump(side, key, delta) {
      const setter = side === "r" ? setReactantCounts : setProductCounts;
      const src = side === "r" ? reactantCounts : productCounts;
      setter({ ...src, [key]: clampInt((src[key] || 0) + delta) });
    }

    function applyPreset(pid) {
      const zeros = {}; allKeys.forEach(k => zeros[k] = 0);
      setReactantCounts(zeros); setProductCounts(zeros);
      setStudentBroken(""); setStudentFormed(""); setStudentDelta("");
      setStudentType(""); setFeedback(""); setCurrentPresetId(pid);
    }

    function checkWork() {
      const b = Number(studentBroken), f = Number(studentFormed), d = Number(studentDelta);
      const within = (x, y) => Math.abs(x - y) <= 5;
      const okB = within(b, sumBroken);
      const okF = within(f, sumFormed);
      const okD = within(d, trueDelta);
      const expectedType = trueDelta < 0 ? "exo" : trueDelta > 0 ? "endo" : "neither";
      const okT = studentType === expectedType;
      if (okB && okF && okD && okT) setFeedback("✅ Great work! Your numbers and classification look correct!");
      else {
        const miss = [];
        if (!okB) miss.push("ΣE Broken");
        if (!okF) miss.push("ΣE Formed");
        if (!okD) miss.push("ΔH");
        if (!okT) miss.push("Reaction Type");
        setFeedback("⚠️ Recheck → " + miss.join(", ") + ".");
      }
    }

    return (
      <div className="max-w-7xl mx-auto p-6 space-y-8">
        <h1 className="text-3xl font-bold text-center text-slate-800">
          Endothermic / Exothermic Bond Energy Simulator
        </h1>

        {/* Student Info */}
        <div className="bg-white rounded-2xl shadow p-4 flex flex-col sm:flex-row gap-3 justify-center">
          <input className="border rounded-lg px-3 py-2 w-64" placeholder="Full Name"
                 value={studentName} onChange={e => setStudentName(e.target.value)} />
          <input className="border rounded-lg px-3 py-2 w-32" placeholder="Period"
                 value={studentPeriod} onChange={e => setStudentPeriod(e.target.value)} />
        </div>

        {/* Step 1 – Reaction Preset */}
        <div className="bg-white rounded-2xl shadow p-4">
          <h2 className="font-semibold mb-2">Step 1 — Choose a Reaction</h2>
          <div className="space-y-2">
            {PRESETS.map(p => (
              <button key={p.id}
                className={`w-full text-left p-3 rounded-lg transition ${currentPresetId===p.id?
                  "bg-green-100 border border-green-300":"bg-slate-100 hover:bg-slate-200"}`}
                onClick={() => applyPreset(p.id)}>
                <div className="font-medium">{p.name}</div>
                <div className="text-xs text-slate-600">{p.description}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Step 2 – Molecules */}
        {currentPresetId && (
          <div className="grid md:grid-cols-2 gap-6">
            <ModelPanel side="r" title="Reactants — Bonds Broken"
                        presetId={currentPresetId}
                        onClickBond={(bondKey,subtract)=>bump('r',bondKey,subtract?-1:1)}
                        themeColor={THEME.REACTANT}/>
            <ModelPanel side="p" title="Products — Bonds Formed"
                        presetId={currentPresetId}
                        onClickBond={(bondKey,subtract)=>bump('p',bondKey,subtract?-1:1)}
                        themeColor={THEME.PRODUCT}/>
          </div>
        )}

        {/* Step 3 – Student Calculation Pad */}
        {currentPresetId && (
          <div className="bg-white rounded-2xl shadow p-4 space-y-4">
            <h2 className="font-semibold mb-2">Step 3 — Student Calculation Pad</h2>
            <div className="grid sm:grid-cols-3 gap-4">
              <div>
                <label className="text-xs text-slate-600">My ΣE Broken (kJ/mol)</label>
                <input className="w-full border rounded px-2 py-1"
                       value={studentBroken} onChange={e=>setStudentBroken(e.target.value)} />
              </div>
              <div>
                <label className="text-xs text-slate-600">My ΣE Formed (kJ/mol)</label>
                <input className="w-full border rounded px-2 py-1"
                       value={studentFormed} onChange={e=>setStudentFormed(e.target.value)} />
              </div>
              <div>
                <label className="text-xs text-slate-600">My ΔH (Broken − Formed)</label>
                <input className="w-full border rounded px-2 py-1"
                       value={studentDelta} onChange={e=>setStudentDelta(e.target.value)} />
              </div>
            </div>

            <div className="flex flex-wrap items-center gap-3">
              <label className="text-sm text-slate-700">Reaction Type:</label>
              <select className="border rounded-lg px-2 py-1"
                      value={studentType} onChange={e=>setStudentType(e.target.value)}>
                <option value="">Select…</option>
                <option value="endo">Endothermic</option>
                <option value="exo">Exothermic</option>
                <option value="neither">Neither</option>
              </select>
              <button onClick={checkWork}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Check My Work
              </button>
              {feedback && <span className="text-sm text-slate-800">{feedback}</span>}
            </div>
          </div>
        )}

        {/* Step 4 – Chart */}
        {currentPresetId && (
          <div className="bg-white rounded-2xl shadow p-4">
            <h2 className="font-semibold mb-2">Step 4 — Energy Comparison (kJ/mol)</h2>
            <p className="text-xs text-slate-500 mb-3">
              Enter your totals above first. Chart shows your ΣE values.
            </p>
            <div className="h-72">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={chartData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="label" /><YAxis /><Tooltip /><Legend />
                  <Bar dataKey="energy" name="Energy (kJ/mol)">
                    {chartData.map((d,i)=><Cell key={i} fill={d.fill} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
        )}

        {/* Step 5 – Teacher Reference (Summary Display) */}
        {currentPresetId && (
          <div className="bg-slate-100 rounded-2xl p-4 text-sm text-slate-700">
            <h2 className="font-semibold mb-2">Teacher Reference (Computed Totals)</h2>
            <p>ΣE Broken (Reactants): <strong>{sumBroken}</strong> kJ/mol</p>
            <p>ΣE Formed (Products): <strong>{sumFormed}</strong> kJ/mol</p>
            <p>ΔH = <strong>{trueDelta}</strong> kJ/mol → 
              {trueDelta<0?"Exothermic (heat released)":trueDelta>0?"Endothermic (heat absorbed)":"Neither"}
            </p>
          </div>
        )}
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<App />);
  </script>
</body>
</html>
